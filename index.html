<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Sistema Hidrol√≥gico y Meteorol√≥gico de Quito</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="manifest" href="./manifest.json" />
    <link rel="icon" href="./assets/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="./assets/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="./assets/apple-touch-icon.png" />
    <meta name="theme-color" content="#2563eb" />
    <style>
      :root {
        --primary: #2563eb;
        --secondary: #0ea5e9;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1e293b;
        --light: #f8fafc;
        --card-bg: #ffffff;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        background: var(--gradient);
        min-height: 100vh;
        color: var(--dark);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient);
      }

      .header h1 {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 10px;
      }

      .status-bar {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
      }

      .status-indicator {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-connected {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
      }

      .status-error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      .card h3 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--dark);
        font-weight: 600;
      }

      .input-group input,
      .input-group select,
      .input-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: var(--light);
      }

      .input-group input:focus,
      .input-group select:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .btn {
        background: var(--gradient);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .map-container {
        height: 600px;
        border-radius: 15px;
        overflow: hidden;
        margin: 20px 0;
        box-shadow: var(--shadow);
      }

      .weather-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
      }

      .weather-current {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .weather-temp {
        font-size: 3rem;
        font-weight: bold;
      }

      .weather-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .weather-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }

      .forecast-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .forecast-day {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .chat-container {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: var(--shadow);
      }

      .chat-messages {
        height: 400px;
        overflow-y: auto;
        border: 2px solid #e2e8f0;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        background: var(--light);
      }

      .message {
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 10px;
      }

      .message.user {
        background: var(--primary);
        color: white;
        margin-left: 20%;
        text-align: right;
      }

      .message.assistant {
        background: #f1f5f9;
        color: var(--dark);
        margin-right: 20%;
      }

      .alerts-panel {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        color: var(--dark);
      }

      .alert-item {
        background: rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid var(--danger);
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .plants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .plant-card {
        background: var(--light);
        padding: 20px;
        border-radius: 15px;
        border-left: 4px solid var(--secondary);
        transition: all 0.3s ease;
      }

      .plant-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .risk-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .risk-low {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
      }
      .risk-medium {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
      }
      .risk-high {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .status-bar {
          flex-direction: column;
          align-items: center;
        }
      }

      .data-source {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 0.9rem;
      }
    </style>
    <style>
      /* Estilos mejorados para el chatbot Nayra */
      #chat-container {
        max-width: 400px;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #f0f8ff;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        padding: 10px;
        font-family: "Segoe UI", sans-serif;
        z-index: 9999;
      }
      #chat-messages {
        max-height: 250px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .message {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 10px;
      }
      .user-message {
        background-color: #d1e7dd;
        align-self: flex-end;
        text-align: right;
      }
      .bot-message {
        background-color: #fff3cd;
      }
      #chat-input {
        width: 100%;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-tint"></i> Sistema Hidrol√≥gico y Meteorol√≥gico de
          Quito
        </h1>
        <p>
          An√°lisis inteligente con OpenWeather y Gemini AI para gesti√≥n h√≠drica
          urbana
        </p>
        <div class="status-bar">
          <div class="status-indicator status-error" id="weather-status">
            <i class="fas fa-cloud"></i> Clima: Desconectado
          </div>
          <div class="status-indicator status-error" id="gemini-status">
            <i class="fas fa-robot"></i> Gemini: Desconectado
          </div>
        </div>
      </div>
      <div class="dashboard">
        <div class="card">
          <h3><i class="fas fa-key"></i> Configuraci√≥n APIs</h3>
          <div class="input-group">
            <label for="openweather-key">OpenWeather API Key:</label>
            <input
              id="openweather-key"
              placeholder="Tu API Key de OpenWeather"
              type="password"
              value="72c4e33babfabcb045cc45d1a7ea381f"
            />
          </div>
          <div class="input-group">
            <label for="gemini-key">Gemini API Key:</label>
            <input
              id="gemini-key"
              placeholder="Tu API Key de Gemini"
              type="password"
              value="AIzaSyChkgOoEz0-nzzcB5RFttNQHQIwh_QZ_70"
            />
          </div>
          <button class="btn" onclick="connectAPIs()">
            <i class="fas fa-plug"></i> Conectar APIs
          </button>
          <button
            class="btn btn-secondary"
            onclick="diagnoseGeminiAPI()"
            style="margin-top: 10px"
          >
            <i class="fas fa-stethoscope"></i> Diagnosticar Gemini
          </button>
        </div>
        <div class="card">
          <h3><i class="fas fa-upload"></i> Cargar Datos CSV</h3>
          <div class="input-group">
            <label for="csv-file">Archivo CSV de datos hidrol√≥gicos:</label>
            <input
              accept=".csv"
              id="csv-file"
              onchange="loadCSV()"
              type="file"
            />
          </div>
          <div class="input-group">
            <label for="csv-preview">Vista previa de datos:</label>
            <textarea
              id="csv-preview"
              placeholder="Los datos del CSV aparecer√°n aqu√≠..."
              readonly=""
              rows="4"
            ></textarea>
          </div>
          <button class="btn btn-secondary" onclick="analyzeCSVData()">
            <i class="fas fa-chart-line"></i> Analizar Datos
          </button>
        </div>
      </div>
      <div class="card full-width">
        <h3>
          <i class="fas fa-map"></i> Mapa Interactivo - Plantas Potabilizadoras
          y Clima
        </h3>
        <div class="map-container" id="map"></div>
        <div class="data-source">
          <strong>Fuentes de datos:</strong>
          Ubicaciones de plantas: EPMAPS (39 plantas potabilizadoras en DMQ) |
          Datos meteorol√≥gicos: OpenWeather API | Predicciones: An√°lisis con
          Gemini AI
        </div>
      </div>
      <div class="card full-width">
        <h3>
          <i class="fas fa-thermometer-half"></i> Clima Actual y Pron√≥stico
        </h3>
        <div class="weather-card" id="weather-info">
          <div class="weather-current">
            <div>
              <div class="weather-temp" id="current-temp">--¬∞C</div>
              <div id="current-desc">Cargando...</div>
              <div id="current-location">Quito, Ecuador</div>
            </div>
            <div>
              <i class="fas fa-cloud fa-4x" id="weather-icon"></i>
            </div>
          </div>
          <div class="weather-details">
            <div class="weather-item">
              <div><i class="fas fa-eye"></i></div>
              <div id="visibility">-- km</div>
              <div>Visibilidad</div>
            </div>
            <div class="weather-item">
              <div><i class="fas fa-tint"></i></div>
              <div id="humidity">--%</div>
              <div>Humedad</div>
            </div>
            <div class="weather-item">
              <div><i class="fas fa-wind"></i></div>
              <div id="wind-speed">-- km/h</div>
              <div>Viento</div>
            </div>
            <div class="weather-item">
              <div><i class="fas fa-thermometer"></i></div>
              <div id="feels-like">--¬∞C</div>
              <div>Sensaci√≥n</div>
            </div>
          </div>
          <div class="forecast-grid" id="forecast"></div>
          <div class="data-source">
            <i class="fas fa-info-circle"></i>
            <strong>Fuente:</strong> OpenWeather API - Datos meteorol√≥gicos en
            tiempo real para Quito, Ecuador
          </div>
        </div>
      </div>
      <div class="card full-width">
        <h3>
          <i class="fas fa-industry"></i> Principales Plantas Potabilizadoras de
          Quito
        </h3>
        <div class="plants-grid">
          <div class="plant-card">
            <h4><i class="fas fa-water"></i> El Placer</h4>
            <p><strong>Sistema:</strong> Pita-Tambo</p>
            <p><strong>Ubicaci√≥n:</strong> Sur de Quito</p>
            <p><strong>Servicio:</strong> Centro y sur</p>
            <div class="risk-badge risk-medium">Riesgo Medio</div>
          </div>
          <div class="plant-card">
            <h4><i class="fas fa-water"></i> Puengas√≠</h4>
            <p><strong>Sistema:</strong> Pita-Tambo</p>
            <p><strong>Ubicaci√≥n:</strong> Sector Puengas√≠</p>
            <p><strong>Servicio:</strong> Centro y sur</p>
            <div class="risk-badge risk-low">Riesgo Bajo</div>
          </div>
          <div class="plant-card">
            <h4><i class="fas fa-water"></i> El Troje</h4>
            <p><strong>Sistema:</strong> La Mica-Quito Sur</p>
            <p><strong>Capacidad:</strong> 1,650 L/s del Antisana</p>
            <p><strong>Ubicaci√≥n:</strong> Sur de Quito</p>
            <div class="risk-badge risk-high">Riesgo Alto</div>
          </div>
          <div class="plant-card">
            <h4><i class="fas fa-water"></i> Bellavista</h4>
            <p><strong>Sistema:</strong> Papallacta Integrado</p>
            <p><strong>Ubicaci√≥n:</strong> Norte de Quito</p>
            <p><strong>Servicio:</strong> Norte y valles</p>
            <div class="risk-badge risk-low">Riesgo Bajo</div>
          </div>
        </div>
      </div>
      <div class="chat-container">
        <h3><i class="fas fa-comments"></i> Consulta con Gemini AI</h3>
        <div class="chat-messages" id="chat-messages">
          <div class="message assistant">
            <strong>Gemini AI:</strong> ¬°Hola! Soy tu asistente especializado en
            an√°lisis hidrol√≥gico de Quito. Puedo ayudarte con recomendaciones
            sobre gesti√≥n del agua, an√°lisis de riesgos clim√°ticos y
            predicciones basadas en los datos meteorol√≥gicos de OpenWeather.
          </div>
        </div>
        <div class="input-group">
          <textarea
            id="user-message"
            placeholder="Pregunta sobre clima, gesti√≥n del agua, riesgos de inundaci√≥n, etc."
            rows="3"
          ></textarea>
        </div>
        <button class="btn" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i> Enviar Consulta
        </button>
        <button class="btn btn-secondary" onclick="generateRiskReport()">
          <i class="fas fa-exclamation-triangle"></i> Generar Reporte de Alertas
        </button>
      </div>
      <div class="alerts-panel">
        <h3>
          <i class="fas fa-exclamation-triangle"></i> Sistema de Alertas - Quito
        </h3>
        <div id="alerts-content">
          <div class="alert-item">
            <strong>Estado del Sistema:</strong> Esperando conexi√≥n con APIs
            para generar alertas personalizadas.
          </div>
        </div>
      </div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Procesando con inteligencia artificial...</p>
      </div>
          <div
      class="card full-width"
      style="
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        text-align: center;
        padding: 30px;
        margin-top: 30px;
      "
    >
      <h3><i class="fas fa-bullhorn"></i> üö® Emergencia - ECU 911</h3>
      <p style="font-size: 1.1rem; margin: 15px 0">
        ¬øNo puedes hacer una llamada desde tu computador? Usa una de estas
        opciones alternativas para reportar una emergencia en Quito.
      </p>

      <div
        style="
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 10px;
          margin: 20px 0;
        "
      >
        <a
          href="tel:911"
          style="
            background-color: white;
            color: #c0392b;
            padding: 12px 30px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
          "
        >
          üìû Llamar al 911
        </a>
        <button
          onclick="toggleOpcionesECU()"
          style="
            background-color: #f1c40f;
            color: #2c3e50;
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
          "
        >
          üí¨ Otras formas de contacto
        </button>
      </div>

      <div
        id="opciones-ecu"
        style="
          display: none;
          background-color: rgba(255, 255, 255, 0.1);
          padding: 20px;
          border-radius: 10px;
          text-align: left;
          max-width: 600px;
          margin: 0 auto;
        "
      >
        <ul style="list-style: none; padding-left: 0; line-height: 1.6">
          <li>
            üìß <strong>Email:</strong>
            <a href="mailto:contacto@ecu911.gob.ec" style="color: #ecf0f1"
              >contacto@ecu911.gob.ec</a
            >
          </li>
          <li>
            üåê <strong>Chat en l√≠nea:</strong>
            <a
              href="https://www.ecu911.gob.ec"
              target="_blank"
              style="color: #ecf0f1"
              >www.ecu911.gob.ec</a
            >
          </li>
          <li>
            üì∑ <strong>Redes sociales:</strong> Twitter / X:
            <a
              href="https://twitter.com/ECU911Quito"
              target="_blank"
              style="color: #ecf0f1"
              >@ECU911Quito</a
            >
          </li>
          <li>
            üìç <strong>Ubicaci√≥n:</strong> Usa Google Maps y copia tu ubicaci√≥n
            para enviarla
          </li>
        </ul>

        <button
          onclick="copiarMensajeEmergencia()"
          style="
            margin-top: 15px;
            background-color: #ffffff;
            color: #c0392b;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
          "
        >
          üìã Copiar mensaje de emergencia
        </button>

        <p
          id="mensaje-copiado"
          style="
            margin-top: 10px;
            font-size: 0.85rem;
            color: #2ecc71;
            display: none;
          "
        >
          ‚úÖ Mensaje copiado al portapapeles.
        </p>

        <p style="font-size: 0.85rem; margin-top: 15px">
          ‚ö†Ô∏è Recuerda: si puedes usar un tel√©fono, la llamada directa al 911 es
          m√°s r√°pida y efectiva.
        </p>
      </div>

      <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.9">
        El ECU 911 est√° disponible 24/7 para emergencias en todo el pa√≠s.
      </p>
    </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
      // Variables globales
      let map = null;
      let weatherAPI = "72c4e33babfabcb045cc45d1a7ea381f";
      let geminiAPI = "AIzaSyChkgOoEz0-nzzcB5RFttNQHQIwh_QZ_70";
      let csvData = null;
      let connectedAPIs = { weather: false, gemini: false };

      // Coordenadas de Quito
      const QUITO_COORDS = [-0.1807, -78.4678];

      // Plantas potabilizadoras con coordenadas reales aproximadas
      const waterPlants = [
        {
          name: "El Placer",
          lat: -0.25,
          lng: -78.52,
          risk: "medium",
          system: "Pita-Tambo",
        },
        {
          name: "Puengas√≠",
          lat: -0.2,
          lng: -78.45,
          risk: "low",
          system: "Pita-Tambo",
        },
        {
          name: "El Troje",
          lat: -0.3,
          lng: -78.48,
          risk: "high",
          system: "La Mica-Quito Sur",
        },
        {
          name: "Bellavista",
          lat: -0.12,
          lng: -78.46,
          risk: "low",
          system: "Papallacta Integrado",
        },
        {
          name: "Conocoto",
          lat: -0.32,
          lng: -78.4,
          risk: "medium",
          system: "La Mica Apoyo",
        },
        {
          name: "La Mica (Captaci√≥n)",
          lat: -0.45,
          lng: -78.2,
          risk: "high",
          system: "Captaci√≥n Antisana",
        },
      ];

      // Inicializar mapa
      function initializeMap() {
        map = L.map("map").setView(QUITO_COORDS, 11);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);

        // Agregar plantas potabilizadoras
        waterPlants.forEach((plant) => {
          const color =
            plant.risk === "high"
              ? "red"
              : plant.risk === "medium"
              ? "orange"
              : "green";

          L.marker([plant.lat, plant.lng]).addTo(map).bindPopup(`
                        <div style="text-align: center;">
                            <h4>üè≠ ${plant.name}</h4>
                            <p><strong>Sistema:</strong> ${plant.system}</p>
                            <p><strong>Riesgo:</strong> <span style="color: ${color}; font-weight: bold;">${plant.risk.toUpperCase()}</span></p>
                        </div>
                    `);
        });

        // Agregar marcador del clima actual
        L.marker(QUITO_COORDS)
          .addTo(map)
          .bindPopup(
            "<h4>üå§Ô∏è Estaci√≥n Meteorol√≥gica Quito</h4><p>Datos en tiempo real de OpenWeather</p>"
          );
      }

      // Conectar APIs
      async function connectAPIs() {
        weatherAPI =
          document.getElementById("openweather-key").value.trim() || weatherAPI;
        geminiAPI =
          document.getElementById("gemini-key").value.trim() || geminiAPI;

        showLoading(true);

        // Probar conexi√≥n con OpenWeather
        try {
          const weatherResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
          );

          if (weatherResponse.ok) {
            connectedAPIs.weather = true;
            document.getElementById("weather-status").innerHTML =
              '<i class="fas fa-cloud"></i> Clima: Conectado';
            document.getElementById("weather-status").className =
              "status-indicator status-connected";

            // Cargar datos del clima
            await loadWeatherData();
          } else {
            throw new Error("API Key de OpenWeather inv√°lida");
          }
        } catch (error) {
          console.error("Error conectando OpenWeather:", error);
          document.getElementById("weather-status").innerHTML =
            '<i class="fas fa-cloud"></i> Clima: Error';
        }

        // Probar conexi√≥n con Gemini
        try {
          console.log("Intentando conectar con Gemini API...");
          console.log("API Key utilizada:", geminiAPI.substring(0, 10) + "...");

          const geminiResponse = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiAPI}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: "Test de conexi√≥n. Responde brevemente que est√°s conectado.",
                      },
                    ],
                  },
                ],
              }),
            }
          );

          console.log("Respuesta de Gemini - Status:", geminiResponse.status);
          console.log("Respuesta de Gemini - Headers:", geminiResponse.headers);

          if (geminiResponse.ok) {
            const responseData = await geminiResponse.json();
            console.log("Datos de respuesta exitosa:", responseData);

            connectedAPIs.gemini = true;
            document.getElementById("gemini-status").innerHTML =
              '<i class="fas fa-robot"></i> Gemini: Conectado';
            document.getElementById("gemini-status").className =
              "status-indicator status-connected";

            addMessage(
              "assistant",
              "‚úÖ Gemini AI conectado exitosamente. Sistema listo para an√°lisis avanzado."
            );
          } else {
            const errorData = await geminiResponse.json();
            console.error("Error en respuesta de Gemini:", errorData);
            throw new Error(
              `Error ${geminiResponse.status}: ${
                errorData.error?.message || "API Key de Gemini inv√°lida"
              }`
            );
          }
        } catch (error) {
          console.error("Error conectando Gemini:", error);
          document.getElementById("gemini-status").innerHTML =
            '<i class="fas fa-robot"></i> Gemini: Error';

          // Mostrar error espec√≠fico en el chat
          addMessage(
            "assistant",
            `‚ùå Error conectando Gemini AI: ${error.message}\n\nPosibles causas:\n‚Ä¢ API Key incorrecta o inv√°lida\n‚Ä¢ Cuota excedida\n‚Ä¢ Regi√≥n no soportada\n‚Ä¢ Servicio temporalmente no disponible\n\nRevisa la consola del navegador (F12) para m√°s detalles.`
          );
        }

        showLoading(false);

        if (connectedAPIs.weather && connectedAPIs.gemini) {
          generateInitialAnalysis();
        }
      }

      // Cargar datos del clima
      async function loadWeatherData() {
        try {
          // Clima actual
          const currentResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
          );
          const currentData = await currentResponse.json();

          // Pron√≥stico 5 d√≠as
          const forecastResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
          );
          const forecastData = await forecastResponse.json();

          updateWeatherDisplay(currentData, forecastData);
          updateMapWithWeather(currentData);
        } catch (error) {
          console.error("Error cargando datos del clima:", error);
        }
      }

      // Actualizar visualizaci√≥n del clima
      function updateWeatherDisplay(current, forecast) {
        // Datos actuales
        document.getElementById("current-temp").textContent = `${Math.round(
          current.main.temp
        )}¬∞C`;
        document.getElementById("current-desc").textContent =
          current.weather[0].description;
        document.getElementById("visibility").textContent = `${(
          current.visibility / 1000
        ).toFixed(1)} km`;
        document.getElementById(
          "humidity"
        ).textContent = `${current.main.humidity}%`;
        document.getElementById("wind-speed").textContent = `${(
          current.wind.speed * 3.6
        ).toFixed(1)} km/h`;
        document.getElementById("feels-like").textContent = `${Math.round(
          current.main.feels_like
        )}¬∞C`;

        // Icono del clima
        const iconMap = {
          clear: "sun",
          clouds: "cloud",
          rain: "cloud-rain",
          thunderstorm: "bolt",
          snow: "snowflake",
          mist: "smog",
        };
        const weatherType = current.weather[0].main.toLowerCase();
        const iconClass = iconMap[weatherType] || "cloud";
        document.getElementById(
          "weather-icon"
        ).className = `fas fa-${iconClass} fa-4x`;

        // Pron√≥stico 5 d√≠as (tomamos uno por d√≠a)
        const forecastElement = document.getElementById("forecast");
        forecastElement.innerHTML = "";

        const dailyForecasts = forecast.list
          .filter((item, index) => index % 8 === 0)
          .slice(0, 5);

        dailyForecasts.forEach((day) => {
          const date = new Date(day.dt * 1000);
          const dayName = date.toLocaleDateString("es-ES", {
            weekday: "short",
          });

          const dayElement = document.createElement("div");
          dayElement.className = "forecast-day";
          dayElement.innerHTML = `
                    <div>${dayName}</div>
                    <div><i class="fas fa-${
                      iconMap[day.weather[0].main.toLowerCase()] || "cloud"
                    }"></i></div>
                    <div>${Math.round(day.main.temp)}¬∞C</div>
                    <div style="font-size: 0.8em;">${
                      day.weather[0].description
                    }</div>
                `;
          forecastElement.appendChild(dayElement);
        });
      }

      // Actualizar mapa con datos del clima
      function updateMapWithWeather(weatherData) {
        // Agregar c√≠rculos de temperatura en diferentes zonas
        const tempColor =
          weatherData.main.temp > 20
            ? "red"
            : weatherData.main.temp > 15
            ? "orange"
            : "blue";

        // Zona norte (m√°s fr√≠a)
        L.circle([-0.1, -78.47], {
          color: "blue",
          fillColor: "blue",
          fillOpacity: 0.2,
          radius: 2000,
        }).addTo(map).bindPopup(`
                <h4>üå°Ô∏è Zona Norte</h4>
                <p>Temperatura estimada: ${Math.round(
                  weatherData.main.temp - 2
                )}¬∞C</p>
                <p>Mayor altitud, temperaturas m√°s bajas</p>
            `);

        // Zona centro
        L.circle([-0.18, -78.47], {
          color: tempColor,
          fillColor: tempColor,
          fillOpacity: 0.2,
          radius: 2000,
        }).addTo(map).bindPopup(`
                <h4>üå°Ô∏è Centro de Quito</h4>
                <p>Temperatura actual: ${Math.round(
                  weatherData.main.temp
                )}¬∞C</p>
                <p>Humedad: ${weatherData.main.humidity}%</p>
                <p>${weatherData.weather[0].description}</p>
            `);

        // Zona sur (m√°s c√°lida)
        L.circle([-0.25, -78.48], {
          color: "orange",
          fillColor: "orange",
          fillOpacity: 0.2,
          radius: 2000,
        }).addTo(map).bindPopup(`
                <h4>üå°Ô∏è Zona Sur</h4>
                <p>Temperatura estimada: ${Math.round(
                  weatherData.main.temp + 1
                )}¬∞C</p>
                <p>Menor altitud, temperaturas m√°s altas</p>
            `);

        // Agregar indicadores de lluvia si est√° lloviendo
        if (weatherData.weather[0].main.toLowerCase().includes("rain")) {
          L.circle([-0.18, -78.47], {
            color: "purple",
            fillColor: "purple",
            fillOpacity: 0.1,
            radius: 5000,
          })
            .addTo(map)
            .bindPopup("‚òî Zona de lluvia activa");
        }
      }

      // Cargar CSV
      function loadCSV() {
        const fileInput = document.getElementById("csv-file");
        const file = fileInput.files[0];

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const csvText = e.target.result;
            csvData = csvText;

            // Mostrar preview
            const lines = csvText.split("\n").slice(0, 5);
            document.getElementById("csv-preview").value =
              lines.join("\n") + "\n... (mostrando primeras 5 l√≠neas)";
          };
          reader.readAsText(file);
        }
      }

      // Analizar datos CSV
      async function analyzeCSVData() {
        if (!csvData) {
          alert("Por favor, carga primero un archivo CSV");
          return;
        }

        if (!connectedAPIs.gemini) {
          alert("Conecta primero la API de Gemini para an√°lisis");
          return;
        }

        showLoading(true);

        const prompt = `Analiza estos datos hidrol√≥gicos de Quito como experto en recursos h√≠dricos. 

DATOS CSV:
${csvData.substring(0, 2000)}

CONTEXTO DE QUITO:
- Ciudad –∞–Ω–¥ina a 2,850 msnm
- Vulnerabilidades: volcanes (Pichincha, Antisana), deslizamientos, estacionalidad
- 39 plantas potabilizadoras, sistemas Pita-Tambo, La Mica, Papallacta
- Poblaci√≥n: 2.8 millones en DMQ

AN√ÅLISIS REQUERIDO:
1. Identificar patrones y tendencias en los datos
2. Evaluar riesgos de inundaci√≥n/sequ√≠a por zona
3. Correlaci√≥n con datos meteorol√≥gicos actuales
4. Recomendaciones espec√≠ficas para gesti√≥n h√≠drica
5. Predicciones a corto/mediano plazo
6. Medidas preventivas por sector de Quito

COMPARACI√ìN CON DATOS METEOROL√ìGICOS:
Incluye c√≥mo estos datos hist√≥ricos se relacionan con las condiciones clim√°ticas actuales obtenidas de OpenWeather para generar predicciones m√°s precisas.

Proporciona un an√°lisis t√©cnico detallado con recomendaciones espec√≠ficas.`;

        try {
          console.log("Enviando an√°lisis CSV a Gemini...");

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiAPI}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
              }),
            }
          );

          console.log("Respuesta an√°lisis CSV - Status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("Error en an√°lisis CSV:", errorData);
            throw new Error(
              `Error ${response.status}: ${
                errorData.error?.message || "Error desconocido"
              }`
            );
          }

          const data = await response.json();
          console.log("Datos de an√°lisis CSV recibidos:", data);

          if (data.candidates && data.candidates[0]) {
            const analysis = data.candidates[0].content.parts[0].text;

            // Mostrar an√°lisis en el chat
            addMessage(
              "assistant",
              `üìä AN√ÅLISIS DE DATOS CSV COMPLETADO\n\n${analysis}\n\nüìç FUENTES: Datos CSV cargados + OpenWeather API + An√°lisis Gemini AI`
            );
          } else {
            throw new Error("Respuesta vac√≠a de Gemini AI");
          }
        } catch (error) {
          console.error("Error en an√°lisis CSV:", error);
          addMessage(
            "assistant",
            `‚ùå Error al analizar datos CSV: ${error.message}\n\nRevisa la consola del navegador (F12) para m√°s detalles.`
          );
        }

        showLoading(false);
      }

      // Enviar mensaje al chat
      async function sendMessage() {
        const messageInput = document.getElementById("user-message");
        const message = messageInput.value.trim();

        if (!message) return;

        if (!connectedAPIs.gemini) {
          alert("Conecta primero la API de Gemini");
          return;
        }

        addMessage("user", message);
        messageInput.value = "";

        showLoading(true);

        // Obtener datos meteorol√≥gicos actuales para contexto
        let weatherContext = "";
        if (connectedAPIs.weather) {
          try {
            const weatherResponse = await fetch(
              `https://api.openweathermap.org/data/2.5/weather?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
            );
            const weatherData = await weatherResponse.json();

            weatherContext = `\n\nDATOS METEOROL√ìGICOS ACTUALES DE QUITO (OpenWeather):
- Temperatura: ${weatherData.main.temp}¬∞C
- Humedad: ${weatherData.main.humidity}%
- Presi√≥n: ${weatherData.main.pressure} hPa
- Viento: ${weatherData.wind.speed} m/s
- Condici√≥n: ${weatherData.weather[0].description}
- Visibilidad: ${weatherData.visibility} metros`;
          } catch (error) {
            console.error("Error obteniendo datos meteorol√≥gicos:", error);
          }
        }

        const prompt = `Eres un experto en gesti√≥n h√≠drica y meteorolog√≠a de Quito, Ecuador. Responde con conocimiento t√©cnico especializado.

CONSULTA DEL USUARIO: ${message}

CONTEXTO QUITO:
- Ubicaci√≥n: Andes ecuatorianos, 2,850 msnm
- Infraestructura h√≠drica: 39 plantas potabilizadoras
- Sistemas principales: Pita-Tambo, La Mica-Quito Sur, Papallacta Integrado
- Vulnerabilidades: volcanes, deslizamientos, variabilidad clim√°tica
- Cobertura: 98.2% agua potable, 92% alcantarillado${weatherContext}

INSTRUCCIONES:
- Proporciona recomendaciones t√©cnicas espec√≠ficas para Quito
- Considera los datos meteorol√≥gicos actuales en tu an√°lisis
- Incluye medidas preventivas y de gesti√≥n de riesgos
- Explica c√≥mo las condiciones actuales afectan la gesti√≥n h√≠drica
- Sugiere acciones concretas basadas en la situaci√≥n meteorol√≥gica

Responde de manera t√©cnica pero comprensible, con recomendaciones pr√°cticas.`;

        try {
          console.log("Enviando mensaje a Gemini...");
          console.log("Prompt enviado:", prompt.substring(0, 200) + "...");

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiAPI}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
              }),
            }
          );

          console.log("Respuesta mensaje - Status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("Error en mensaje:", errorData);
            throw new Error(
              `Error ${response.status}: ${
                errorData.error?.message || "Error desconocido"
              }`
            );
          }

          const data = await response.json();
          console.log("Respuesta mensaje recibida:", data);

          if (data.candidates && data.candidates[0]) {
            const answer = data.candidates[0].content.parts[0].text;
            addMessage("assistant", answer);
          } else {
            throw new Error("Respuesta vac√≠a de Gemini AI");
          }
        } catch (error) {
          console.error("Error enviando mensaje:", error);
          addMessage(
            "assistant",
            `‚ùå Error de conexi√≥n con Gemini AI: ${error.message}\n\nVerifica tu API key y cuota disponible.`
          );
        }

        showLoading(false);
      }

      // Agregar mensaje al chat
      function addMessage(sender, text) {
        const messagesContainer = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const timestamp = new Date().toLocaleTimeString("es-EC");
        const senderName = sender === "user" ? "Usuario" : "Gemini AI";

        messageDiv.innerHTML = `<strong>${senderName}:</strong> ${text}<br><small style="opacity: 0.7;">${timestamp}</small>`;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Generar reporte de alertas
      async function generateRiskReport() {
        if (!connectedAPIs.gemini || !connectedAPIs.weather) {
          alert("Conecta ambas APIs para generar el reporte");
          return;
        }

        showLoading(true);

        try {
          // Obtener datos meteorol√≥gicos para el reporte
          const weatherResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
          );
          const forecastResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
          );

          const weatherData = await weatherResponse.json();
          const forecastData = await forecastResponse.json();

          const prompt = `Genera un reporte completo de alertas de riesgo para Quito basado en datos meteorol√≥gicos actuales de OpenWeather.

DATOS METEOROL√ìGICOS ACTUALES:
- Temperatura: ${weatherData.main.temp}¬∞C
- Humedad: ${weatherData.main.humidity}%
- Presi√≥n: ${weatherData.main.pressure} hPa
- Viento: ${weatherData.wind.speed} m/s, direcci√≥n ${weatherData.wind.deg}¬∞
- Condici√≥n: ${weatherData.weather[0].description}
- Visibilidad: ${weatherData.visibility} metros
- Sensaci√≥n t√©rmica: ${weatherData.main.feels_like}¬∞C

PRON√ìSTICO 5 D√çAS:
${forecastData.list
  .slice(0, 8)
  .map(
    (item) =>
      `${new Date(item.dt * 1000).toLocaleDateString("es-ES")}: ${
        item.main.temp
      }¬∞C, ${item.weather[0].description}, Humedad ${item.main.humidity}%`
  )
  .join("\n")}

GENERA REPORTE CON:

1. NIVEL DE ALERTA GENERAL (Verde/Amarillo/Naranja/Rojo)
2. RIESGOS ESPEC√çFICOS POR ZONA:
   - Norte de Quito (Carcel√©n, Calder√≥n)
   - Centro (Centro Hist√≥rico, La Mariscal)
   - Sur (Quitumbe, Chillogallo)
   - Valles (Tumbaco, Cumbay√°)

3. ALERTAS HIDROL√ìGICAS:
   - Riesgo de inundaci√≥n por precipitaciones
   - Vulnerabilidad en plantas potabilizadoras
   - Posibles afectaciones en captaci√≥n La Mica
   - Estado de sistemas de distribuci√≥n

4. RECOMENDACIONES INMEDIATAS:
   - Para autoridades (EPMAPS, Municipio)
   - Para ciudadanos
   - Medidas preventivas por sector

5. CRONOGRAMA DE SEGUIMIENTO:
   - Pr√≥ximas 24 horas
   - Pr√≥ximos 3 d√≠as
   - Pr√≥xima semana

Considera factores espec√≠ficos de Quito: altitud, topograf√≠a, √©poca del a√±o, vulnerabilidades volc√°nicas y s√≠smicas.

Formato: Reporte t√©cnico oficial con niveles de urgencia claros.`;

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiAPI}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
              }),
            }
          );

          const data = await response.json();

          if (data.candidates && data.candidates[0]) {
            const report = data.candidates[0].content.parts[0].text;

            // Actualizar panel de alertas
            const alertsContent = document.getElementById("alerts-content");
            alertsContent.innerHTML = `
                        <div class="alert-item">
                            <h4>üìã REPORTE GENERADO - ${new Date().toLocaleString(
                              "es-EC"
                            )}</h4>
                            <div style="white-space: pre-wrap; margin-top: 15px;">${report}</div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 0.9em;">
                                <strong>üìä Fuentes de datos:</strong><br>
                                ‚Ä¢ Datos meteorol√≥gicos: OpenWeather API en tiempo real<br>
                                ‚Ä¢ An√°lisis predictivo: Google Gemini AI<br>
                                ‚Ä¢ Contexto local: Sistema de gesti√≥n h√≠drica de Quito (EPMAPS)<br>
                                ‚Ä¢ Generado: ${new Date().toLocaleString(
                                  "es-EC"
                                )}
                            </div>
                        </div>
                    `;

            // Tambi√©n agregar al chat
            addMessage(
              "assistant",
              `üö® REPORTE DE ALERTAS GENERADO\n\nSe ha creado un reporte completo de riesgos basado en:\n- Datos meteorol√≥gicos actuales de OpenWeather\n- An√°lisis predictivo con Gemini AI\n- Contexto espec√≠fico de Quito\n\nRevisa el panel de alertas para ver el reporte completo.`
            );

            // Crear archivo descargable
            createDownloadableReport(report, weatherData);
          }
        } catch (error) {
          console.error("Error generando reporte:", error);
          addMessage(
            "assistant",
            "Error al generar el reporte de alertas. Verifica las conexiones API."
          );
        }

        showLoading(false);
      }

      // Crear archivo descargable del reporte
      function createDownloadableReport(report, weatherData) {
        const reportContent = `REPORTE DE ALERTAS HIDROMETEOROL√ìGICAS - QUITO
================================================================

Fecha de generaci√≥n: ${new Date().toLocaleString("es-EC")}
Fuente de datos: OpenWeather API + An√°lisis Gemini AI

CONDICIONES METEOROL√ìGICAS ACTUALES:
- Temperatura: ${weatherData.main.temp}¬∞C
- Humedad: ${weatherData.main.humidity}%
- Presi√≥n: ${weatherData.main.pressure} hPa
- Viento: ${weatherData.wind.speed} m/s
- Condici√≥n: ${weatherData.weather[0].description}

AN√ÅLISIS Y RECOMENDACIONES:
${report}

================================================================
Sistema Hidrol√≥gico y Meteorol√≥gico de Quito
Desarrollado con OpenWeather API y Google Gemini AI
================================================================`;

        const blob = new Blob([reportContent], {
          type: "text/plain;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `Reporte_Alertas_Quito_${
          new Date().toISOString().split("T")[0]
        }.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        addMessage(
          "assistant",
          "üìÑ Reporte descargado exitosamente. El archivo contiene el an√°lisis completo con recomendaciones espec√≠ficas para Quito."
        );
      }

      // An√°lisis inicial al conectar APIs
      async function generateInitialAnalysis() {
        try {
          const weatherResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${QUITO_COORDS[0]}&lon=${QUITO_COORDS[1]}&appid=${weatherAPI}&units=metric&lang=es`
          );
          const weatherData = await weatherResponse.json();

          const prompt = `Bas√°ndote en las condiciones meteorol√≥gicas actuales de Quito, proporciona un an√°lisis inicial del estado del sistema h√≠drico.

DATOS ACTUALES:
- Temperatura: ${weatherData.main.temp}¬∞C
- Humedad: ${weatherData.main.humidity}%
- Condici√≥n: ${weatherData.weather[0].description}
- Presi√≥n: ${weatherData.main.pressure} hPa

Como experto en recursos h√≠dricos de Quito, eval√∫a:
1. Estado general del sistema basado en condiciones actuales
2. Riesgos inmediatos por zona
3. Recomendaciones operativas para las pr√≥ximas 24 horas
4. Impacto en plantas potabilizadoras

Respuesta breve y t√©cnica.`;

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiAPI}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
              }),
            }
          );

          const data = await response.json();

          if (data.candidates && data.candidates[0]) {
            const analysis = data.candidates[0].content.parts[0].text;
            addMessage(
              "assistant",
              `üåü AN√ÅLISIS INICIAL DEL SISTEMA\n\n${analysis}\n\n‚úÖ Sistema conectado y operativo. Datos en tiempo real desde OpenWeather API.`
            );
          }
        } catch (error) {
          console.error("Error en an√°lisis inicial:", error);
        }
      }

      // Funciones auxiliares
      function showLoading(show) {
        const loading = document.getElementById("loading");
        loading.className = show ? "loading show" : "loading";
      }

      // Event listeners
      document
        .getElementById("user-message")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && e.ctrlKey) {
            sendMessage();
          }
        });

      // Inicializaci√≥n
      document.addEventListener("DOMContentLoaded", function () {
        initializeMap();

        // Pre-llenar las API keys si est√°n disponibles
        document.getElementById("openweather-key").value = weatherAPI;
        document.getElementById("gemini-key").value = geminiAPI;

        addMessage(
          "assistant",
          `üåä ¬°Bienvenido al Sistema Hidrol√≥gico y Meteorol√≥gico de Quito!

Este sistema integra:
üå§Ô∏è OpenWeather API - Datos meteorol√≥gicos en tiempo real
ü§ñ Google Gemini AI - An√°lisis predictivo avanzado
üó∫Ô∏è Mapa interactivo - 39 plantas potabilizadoras del DMQ
üìä An√°lisis de datos CSV - Carga tus datos hidrol√≥gicos

Para comenzar:
1. Verifica las API keys pre-cargadas
2. Haz clic en "Conectar APIs"
3. Carga un archivo CSV (opcional)
4. Realiza consultas especializadas

¬øEn qu√© puedo ayudarte hoy?`
        );
      });

      // Funci√≥n de diagn√≥stico espec√≠fica para Gemini
      async function diagnoseGeminiAPI() {
        const apiKey =
          document.getElementById("gemini-key").value.trim() || geminiAPI;

        addMessage("assistant", "üîç Iniciando diagn√≥stico de Gemini API...");

        console.log("=== DIAGN√ìSTICO GEMINI API ===");
        console.log("API Key format:", apiKey.length, "caracteres");
        console.log("Primeros 10 caracteres:", apiKey.substring(0, 10));
        console.log(
          "√öltimos 5 caracteres:",
          apiKey.substring(apiKey.length - 5)
        );

        // Verificar formato de API Key
        if (!apiKey.startsWith("AIza")) {
          addMessage(
            "assistant",
            '‚ùå Error: API Key de Gemini debe comenzar con "AIza"'
          );
          return;
        }

        if (apiKey.length < 35) {
          addMessage(
            "assistant",
            "‚ùå Error: API Key parece muy corta. Debe tener ~39 caracteres"
          );
          return;
        }

        // Probar diferentes endpoints
        const endpoints = ["gemini-pro", "gemini-1.5-flash", "gemini-1.5-pro"];

        for (const model of endpoints) {
          try {
            addMessage("assistant", `üß™ Probando modelo: ${model}...`);
            console.log(`Probando modelo: ${model}`);

            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [{ text: "Responde con una sola palabra: OK" }],
                    },
                  ],
                }),
              }
            );

            console.log(`${model} - Status:`, response.status);
            console.log(`${model} - Status Text:`, response.statusText);

            if (response.ok) {
              const data = await response.json();
              console.log(`${model} - Respuesta exitosa:`, data);
              addMessage("assistant", `‚úÖ ${model}: FUNCIONANDO`);

              // Actualizar configuraci√≥n con el modelo que funciona
              geminiAPI = apiKey;
              connectedAPIs.gemini = true;
              document.getElementById("gemini-status").innerHTML =
                '<i class="fas fa-robot"></i> Gemini: Conectado';
              document.getElementById("gemini-status").className =
                "status-indicator status-connected";

              addMessage(
                "assistant",
                `üéâ ¬°√âxito! Gemini conectado usando modelo: ${model}`
              );
              return;
            } else {
              const errorData = await response.json();
              console.error(`${model} - Error:`, errorData);
              addMessage(
                "assistant",
                `‚ùå ${model}: Error ${response.status} - ${
                  errorData.error?.message || "Error desconocido"
                }`
              );
            }
          } catch (error) {
            console.error(`Error probando ${model}:`, error);
            addMessage(
              "assistant",
              `‚ùå ${model}: Error de conexi√≥n - ${error.message}`
            );
          }
        }

        // Si llegamos aqu√≠, ning√∫n modelo funcion√≥
        addMessage(
          "assistant",
          `‚ùå DIAGN√ìSTICO COMPLETO - GEMINI NO CONECTADO
            
Posibles soluciones:
1. Verifica que tu API Key sea correcta en: https://makersuite.google.com/app/apikey
2. Aseg√∫rate de que Gemini API est√© habilitada para tu proyecto
3. Verifica que tengas cuota disponible
4. Intenta generar una nueva API Key
5. Confirma que tu regi√≥n sea compatible

La API Key actual parece tener el formato correcto pero no funciona con ning√∫n modelo disponible.`
        );
      }

      // Actualizaci√≥n autom√°tica del clima cada 10 minutos
      setInterval(() => {
        if (connectedAPIs.weather) {
          loadWeatherData();
        }
      }, 600000);
    </script>

    <script>
      function getBotResponse(input) {
        input = input.toLowerCase();
        if (input.includes("hola"))
          return "¬°Hola! üòä ¬øEn qu√© puedo ayudarte sobre el r√≠o, el clima o el agua?";
        if (input.includes("r√≠o"))
          return "Los r√≠os son fundamentales üíß para los ecosistemas. ¬øQuieres saber sobre su caudal o conservaci√≥n?";
        if (input.includes("cuenca"))
          return "Una cuenca hidrogr√°fica es el √°rea donde se recoge el agua de lluvia para formar un r√≠o üåßÔ∏è.";
        if (input.includes("lluvia"))
          return "La lluvia es esencial ‚òî para mantener nuestros r√≠os y embalses. ¬øTe interesa saber cu√°nto ha llovido?";
        if (input.includes("ahorro"))
          return "Puedes ahorrar agua üöø cerrando el grifo mientras te cepillas los dientes y usando menos en duchas.";
        if (input.includes("clima"))
          return "El clima afecta directamente el nivel del r√≠o üå¶Ô∏è. ¬øQuieres conocer el clima actual?";
        return "Lo siento üòÖ, no entiendo eso. Prueba preguntando sobre r√≠os, lluvia, ahorro de agua o clima.";
      }
    </script>
    <!-- <section id="alertas" style="padding: 2rem">
      <h2 style="font-size: 1.8rem; color: #2c3e50; margin-bottom: 1rem">
        üì¢ Alertas Comunitarias
      </h2>

      <form
        id="alertForm"
        style="
          background: #f8f9fa;
          padding: 1rem;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          margin-bottom: 2rem;
        "
      >
        <div style="margin-bottom: 1rem">
          <label for="zona" style="display: block; font-weight: bold"
            >üìç Zona afectada:</label
          >
          <input
            type="text"
            id="zona"
            name="zona"
            required
            style="
              width: 100%;
              padding: 0.5rem;
              border: 1px solid #ccc;
              border-radius: 4px;
            "
          />
        </div>
        <div style="margin-bottom: 1rem">
          <label for="descripcion" style="display: block; font-weight: bold"
            >üí¨ Descripci√≥n:</label
          >
          <textarea
            id="descripcion"
            name="descripcion"
            required
            rows="3"
            style="
              width: 100%;
              padding: 0.5rem;
              border: 1px solid #ccc;
              border-radius: 4px;
            "
          ></textarea>
        </div>
        <button
          type="submit"
          style="
            background-color: #27ae60;
            color: white;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-weight: bold;
          "
        >
          Reportar Alerta
        </button>
      </form>

      <div id="alertasFeed"></div>
    </section>

    <script>
      document
        .getElementById("alertForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const zona = document.getElementById("zona").value.trim();
          const descripcion = document
            .getElementById("descripcion")
            .value.trim();
          const fecha = new Date().toLocaleString();

          const alertaHTML = `
      <div style="background: #ecf0f1; border-left: 6px solid #e74c3c; padding: 1rem; margin-bottom: 1rem; border-radius: 6px;">
        <div style="font-weight: bold; margin-bottom: 0.5rem;">üìç Zona: ${zona}</div>
        <div style="margin-bottom: 0.5rem;">üí¨ ${descripcion}</div>
        <div style="font-size: 0.9rem; color: #7f8c8d;">üìÖ ${fecha}</div>
      </div>
    `;

          const feed = document.getElementById("alertasFeed");
          feed.insertAdjacentHTML("afterbegin", alertaHTML);

          document.getElementById("alertForm").reset();
        });
    </script> -->

    <script>
      function toggleOpcionesECU() {
        const panel = document.getElementById("opciones-ecu");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
      }

      function copiarMensajeEmergencia() {
        const baseMensaje = `üö® NECESITO AYUDA URGENTE
Estoy en Quito, no puedo llamar al 911.
Ubicaci√≥n/Zona: [especifica aqu√≠]
Tipo de emergencia: [inundaci√≥n, derrumbe, herido, etc.]`;

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const lat = position.coords.latitude.toFixed(6);
              const lon = position.coords.longitude.toFixed(6);
              const ubicacion = `https://www.google.com/maps?q=${lat},${lon}`;
              const mensaje =
                baseMensaje +
                `\nUbicaci√≥n GPS: ${ubicacion}\nPor favor, contacten lo antes posible.`;

              navigator.clipboard.writeText(mensaje).then(() => {
                document.getElementById("mensaje-copiado").style.display =
                  "block";
                setTimeout(() => {
                  document.getElementById("mensaje-copiado").style.display =
                    "none";
                }, 4000);
              });
            },
            function (error) {
              // Fallback sin GPS
              const mensaje =
                baseMensaje +
                `\nUbicaci√≥n GPS no disponible.\nPor favor, contacten lo antes posible.`;
              navigator.clipboard.writeText(mensaje).then(() => {
                document.getElementById("mensaje-copiado").style.display =
                  "block";
                setTimeout(() => {
                  document.getElementById("mensaje-copiado").style.display =
                    "none";
                }, 4000);
              });
            }
          );
        } else {
          // Geolocalizaci√≥n no soportada
          const mensaje =
            baseMensaje +
            `\nUbicaci√≥n GPS no soportada por el navegador.\nPor favor, contacten lo antes posible.`;
          navigator.clipboard.writeText(mensaje).then(() => {
            document.getElementById("mensaje-copiado").style.display = "block";
            setTimeout(() => {
              document.getElementById("mensaje-copiado").style.display = "none";
            }, 4000);
          });
        }
      }
    </script>
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js");
        }
    </script>
  </body>
</html>
```
